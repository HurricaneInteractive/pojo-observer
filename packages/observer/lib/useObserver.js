"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useUniqueId = useUniqueId;
exports.pureObserver = pureObserver;
exports.default = void 0;

var _react = require("react");

var _hash = _interopRequireDefault(require("./hash"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class EventEmitter {
  constructor() {
    this.callbacks = {};
  }

  on(eventId, subscriptionId, cb) {
    this.callbacks[eventId] = this.callbacks[eventId] || [];
    cb.subscriptionId = subscriptionId;
    this.callbacks[eventId].push(cb);
  }

  remove(eventId, subscriptionId) {
    this.callbacks[eventId] = this.callbacks[eventId].filter(c => c.subscriptionId !== subscriptionId);
  }

  emit(eventId) {
    this.callbacks[eventId] && this.callbacks[eventId].forEach(cb => cb());
  }

}

const eventEmitter = new EventEmitter();

const id = () => 'xxxxxxxxxxxxxxxx'.replace(/[x]/g, () => ((Math.floor(new Date().getTime() / 16) + Math.random() * 16) % 16 | 0 & 0x3 | 0x8).toString(16));

function getFieldNames(toCheck) {
  let props = [];
  let obj = toCheck;

  do {
    props = props.concat(Object.getOwnPropertyNames(obj));
  } while (obj = Object.getPrototypeOf(obj));

  return props.sort().filter((e, i, arr) => e != arr[i + 1] && typeof toCheck[e] !== 'function');
}

function isWritableField(object, fieldName) {
  const fieldDescriptor = Object.getOwnPropertyDescriptor(object, fieldName);
  return fieldDescriptor && fieldDescriptor.writable;
}

function isWriteableObjectField(object, fieldName) {
  return isWritableField(object, fieldName) && typeof object[fieldName] === 'object' && object[fieldName] !== null;
}

function isWriteablePrimitiveField(object, fieldName) {
  return isWritableField(object, fieldName) && (typeof object[fieldName] !== 'object' || object[fieldName] === null);
}

function isWriteableArray(object, fieldName) {
  return isWritableField(object, fieldName) && Array.isArray(object[fieldName]);
}

function attachProxyToProperties(model, callback, id) {
  if (!model.__proxyAttached) {
    model.__proxyAttached = true;
    getFieldNames(model).forEach(field => {
      // eslint-disable-next-line @typescript-eslint/no-use-before-define
      recursivelyAttachProxy(model[field], field, model, id ? id : model.__observableId, callback);
    });
  }
}

function attachProxyToField(object, fieldName, originalField, callback, id) {
  Object.defineProperty(object, fieldName, {
    configurable: true,
    enumerable: true,
    get: () => originalField,
    set: value => {
      if (typeof value === 'object') {
        attachProxyToProperties(value, callback, id);
      }

      originalField = value;
      callback();
    }
  });
}

function attachProxyToArray(object, fieldName, callback, id) {
  object[fieldName].forEach((element, index) => {
    recursivelyAttachProxy(element, index, object[fieldName], id, callback);
  });
  object[fieldName] = new Proxy(object[fieldName], {
    get: function (target, property) {
      return target[property];
    },
    set: function (target, property, value) {
      if (property !== '__proto__' && property !== 'length') {
        if (typeof value === 'object') {
          attachProxyToProperties(value, callback, id);
        }

        target[property] = value;
        callback();
      }

      return true;
    }
  });
}

function recursivelyAttachProxy(originalField, fieldName, object, id, callback) {
  if (isWriteablePrimitiveField(object, fieldName)) return attachProxyToField(object, fieldName, originalField, callback, id);
  if (isWriteableArray(object, fieldName)) return attachProxyToArray(object, fieldName, callback, id);

  if (isWriteableObjectField(object, fieldName)) {
    attachProxyToField(object, fieldName, originalField, callback, id);
    getFieldNames(object[fieldName]).forEach(nestedFieldName => recursivelyAttachProxy(object[fieldName][nestedFieldName], nestedFieldName, object[fieldName], id, callback));
    return;
  }
}

function addId(model) {
  if (!model.__observableId) Object.defineProperty(model, '__observableId', {
    value: id(),
    writable: false
  });
}

function addHash(model) {
  if (!model.hash) model.hash = () => (0, _hash.default)(model);
}

let currentId = 0;

function useUniqueId() {
  const ref = (0, _react.useRef)(0);

  if (ref.current === 0) {
    ref.current = ++currentId;
  }

  return 'subscription_id' + ref.current;
}

function reactify(model) {
  const subscriptionId = useUniqueId();
  const [, stateChange] = (0, _react.useState)(model.hash());
  const stateChangeCallback = (0, _react.useCallback)(() => {
    stateChange(model.hash());
  }, [model.__observableId]);
  (0, _react.useEffect)(() => {
    eventEmitter.on(model.__observableId, subscriptionId, stateChangeCallback);
    return () => eventEmitter.remove(model.__observableId, subscriptionId);
  }, [model.__observableId, subscriptionId]);
  return () => eventEmitter.emit(model.__observableId);
}

function decorate(model) {
  addHash(model);
  addId(model);
}

function useObserver(model) {
  decorate(model);
  const callback = reactify(model);
  attachProxyToProperties(model, callback);
  return model;
}

function pureObserver(model, callback) {
  decorate(model);
  attachProxyToProperties(model, callback);
  return model;
}

var _default = useObserver;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91c2VPYnNlcnZlci50cyJdLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJjYWxsYmFja3MiLCJvbiIsImV2ZW50SWQiLCJzdWJzY3JpcHRpb25JZCIsImNiIiwicHVzaCIsInJlbW92ZSIsImZpbHRlciIsImMiLCJlbWl0IiwiZm9yRWFjaCIsImV2ZW50RW1pdHRlciIsImlkIiwicmVwbGFjZSIsIk1hdGgiLCJmbG9vciIsIkRhdGUiLCJnZXRUaW1lIiwicmFuZG9tIiwidG9TdHJpbmciLCJnZXRGaWVsZE5hbWVzIiwidG9DaGVjayIsInByb3BzIiwib2JqIiwiY29uY2F0IiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImdldFByb3RvdHlwZU9mIiwic29ydCIsImUiLCJpIiwiYXJyIiwiaXNXcml0YWJsZUZpZWxkIiwib2JqZWN0IiwiZmllbGROYW1lIiwiZmllbGREZXNjcmlwdG9yIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwid3JpdGFibGUiLCJpc1dyaXRlYWJsZU9iamVjdEZpZWxkIiwiaXNXcml0ZWFibGVQcmltaXRpdmVGaWVsZCIsImlzV3JpdGVhYmxlQXJyYXkiLCJBcnJheSIsImlzQXJyYXkiLCJhdHRhY2hQcm94eVRvUHJvcGVydGllcyIsIm1vZGVsIiwiY2FsbGJhY2siLCJfX3Byb3h5QXR0YWNoZWQiLCJmaWVsZCIsInJlY3Vyc2l2ZWx5QXR0YWNoUHJveHkiLCJfX29ic2VydmFibGVJZCIsImF0dGFjaFByb3h5VG9GaWVsZCIsIm9yaWdpbmFsRmllbGQiLCJkZWZpbmVQcm9wZXJ0eSIsImNvbmZpZ3VyYWJsZSIsImVudW1lcmFibGUiLCJnZXQiLCJzZXQiLCJ2YWx1ZSIsImF0dGFjaFByb3h5VG9BcnJheSIsImVsZW1lbnQiLCJpbmRleCIsIlByb3h5IiwidGFyZ2V0IiwicHJvcGVydHkiLCJuZXN0ZWRGaWVsZE5hbWUiLCJhZGRJZCIsImFkZEhhc2giLCJoYXNoIiwiY3VycmVudElkIiwidXNlVW5pcXVlSWQiLCJyZWYiLCJjdXJyZW50IiwicmVhY3RpZnkiLCJzdGF0ZUNoYW5nZSIsInN0YXRlQ2hhbmdlQ2FsbGJhY2siLCJkZWNvcmF0ZSIsInVzZU9ic2VydmVyIiwicHVyZU9ic2VydmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLFlBQU4sQ0FBbUI7QUFBQTtBQUFBLFNBQ2pCQyxTQURpQixHQUNMLEVBREs7QUFBQTs7QUFHakJDLEVBQUFBLEVBQUUsQ0FBQ0MsT0FBRCxFQUFVQyxjQUFWLEVBQTBCQyxFQUExQixFQUFvQztBQUNwQyxTQUFLSixTQUFMLENBQWVFLE9BQWYsSUFBMEIsS0FBS0YsU0FBTCxDQUFlRSxPQUFmLEtBQTJCLEVBQXJEO0FBQ0FFLElBQUFBLEVBQUUsQ0FBQ0QsY0FBSCxHQUFvQkEsY0FBcEI7QUFDQSxTQUFLSCxTQUFMLENBQWVFLE9BQWYsRUFBd0JHLElBQXhCLENBQTZCRCxFQUE3QjtBQUNEOztBQUVERSxFQUFBQSxNQUFNLENBQUNKLE9BQUQsRUFBVUMsY0FBVixFQUFnQztBQUNwQyxTQUFLSCxTQUFMLENBQWVFLE9BQWYsSUFBMEIsS0FBS0YsU0FBTCxDQUFlRSxPQUFmLEVBQXdCSyxNQUF4QixDQUN4QkMsQ0FBQyxJQUFJQSxDQUFDLENBQUNMLGNBQUYsS0FBcUJBLGNBREYsQ0FBMUI7QUFHRDs7QUFFRE0sRUFBQUEsSUFBSSxDQUFDUCxPQUFELEVBQWdCO0FBQ2xCLFNBQUtGLFNBQUwsQ0FBZUUsT0FBZixLQUEyQixLQUFLRixTQUFMLENBQWVFLE9BQWYsRUFBd0JRLE9BQXhCLENBQWdDTixFQUFFLElBQUlBLEVBQUUsRUFBeEMsQ0FBM0I7QUFDRDs7QUFqQmdCOztBQW9CbkIsTUFBTU8sWUFBWSxHQUFHLElBQUlaLFlBQUosRUFBckI7O0FBU0EsTUFBTWEsRUFBRSxHQUFHLE1BQ1QsbUJBQW1CQyxPQUFuQixDQUEyQixNQUEzQixFQUFtQyxNQUNqQyxDQUNFLENBQUNDLElBQUksQ0FBQ0MsS0FBTCxDQUFXLElBQUlDLElB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QXNDOUMsY0FBdEMsRUFBc0R1RSxtQkFBdEQ7QUFDQSxXQUFPLE1BQVkvRCxZQUFZLENBQUNMLE1BQWIsQ0FBb0JzQyxLQUFLLENBQUNLLGNBQTFCLEVBQTBDOUMsY0FBMUMsQ0FBbkI7QUFDRCxHQUhELEVBR0csQ0FBQ3lDLEtBQUssQ0FBQ0ssY0FBUCxFQUF1QjlDLGNBQXZCLENBSEg7QUFJQSxTQUFPLE1BQVlRLFlBQVksQ0FBQ0YsSUFBYixDQUFrQm1DLEtBQUssQ0FBQ0ssY0FBeEIsQ0FBbkI7QUFDRDs7QUFFRCxTQUFTMEIsUUFBVCxDQUFrQi9CLEtBQWxCLEVBQXNDO0FBQ3BDc0IsRUFBQUEsT0FBTyxDQUFDdEIsS0FBRCxDQUFQO0FBQ0FxQixFQUFBQSxLQUFLLENBQUNyQixLQUFELENBQUw7QUFDRDs7QUFFRCxTQUFTZ0MsV0FBVCxDQUFzQ2hDLEtBQXRDLEVBQW1EO0FBQ2pEK0IsRUFBQUEsUUFBUSxDQUFDL0IsS0FBRCxDQUFSO0FBQ0EsUUFBTUMsUUFBUSxHQUFHMkIsUUFBUSxDQUFDNUIsS0FBRCxDQUF6QjtBQUNBRCxFQUFBQSx1QkFBdUIsQ0FBQ0MsS0FBRCxFQUFRQyxRQUFSLENBQXZCO0FBQ0EsU0FBT0QsS0FBUDtBQUNEOztBQUVNLFNBQVNpQyxZQUFULENBQXVDakMsS0FBdkMsRUFBaURDLFFBQWpELEVBQXdFO0FBQzdFOEIsRUFBQUEsUUFBUSxDQUFDL0IsS0FBRCxDQUFSO0FBQ0FELEVBQUFBLHVCQUF1QixDQUFDQyxLQUFELEVBQVFDLFFBQVIsQ0FBdkI7QUFDQSxTQUFPRCxLQUFQO0FBQ0Q7O2VBRWNnQyxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHt1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWYsIHVzZVN0YXRlfSBmcm9tICdyZWFjdCdcbmltcG9ydCBoYXNoIGZyb20gJy4vaGFzaCdcblxuY2xhc3MgRXZlbnRFbWl0dGVyIHtcbiAgY2FsbGJhY2tzID0ge31cblxuICBvbihldmVudElkLCBzdWJzY3JpcHRpb25JZCwgY2IpOiB2b2lkIHtcbiAgICB0aGlzLmNhbGxiYWNrc1tldmVudElkXSA9IHRoaXMuY2FsbGJhY2tzW2V2ZW50SWRdIHx8IFtdXG4gICAgY2Iuc3Vic2NyaXB0aW9uSWQgPSBzdWJzY3JpcHRpb25JZFxuICAgIHRoaXMuY2FsbGJhY2tzW2V2ZW50SWRdLnB1c2goY2IpXG4gIH1cblxuICByZW1vdmUoZXZlbnRJZCwgc3Vic2NyaXB0aW9uSWQpOiB2b2lkIHtcbiAgICB0aGlzLmNhbGxiYWNrc1tldmVudElkXSA9IHRoaXMuY2FsbGJhY2tzW2V2ZW50SWRdLmZpbHRlcihcbiAgICAgIGMgPT4gYy5zdWJzY3JpcHRpb25JZCAhPT0gc3Vic2NyaXB0aW9uSWRcbiAgICApXG4gIH1cblxuICBlbWl0KGV2ZW50SWQpOiB2b2lkIHtcbiAgICB0aGlzLmNhbGxiYWNrc1tldmVudElkXSAmJiB0aGlzLmNhbGxiYWNrc1tldmVudElkXS5mb3JFYWNoKGNiID0+IGNiKCkpXG4gIH1cbn1cblxuY29uc3QgZXZlbnRFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpXG5cbnR5cGUgTW9kZWwgPSB7XG4gIGNvbnN0cnVjdG9yXG4gIF9fb2JzZXJ2YWJsZUlkPzogc3RyaW5nXG4gIF9fcHJveHlBdHRhY2hlZD86IGJvb2xlYW5cbiAgaGFzaD86ICgpID0+IHN0cmluZ1xufVxuXG5jb25zdCBpZCA9ICgpOiBzdHJpbmcgPT5cbiAgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PlxuICAgIChcbiAgICAgIChNYXRoLmZsb29yKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTYpICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHxcbiAgICAgICgwICYgMHgzKSB8XG4gICAgICAweDhcbiAgICApLnRvU3RyaW5nKDE2KVxuICApXG5cbmZ1bmN0aW9uIGdldEZpZWxkTmFtZXModG9DaGVjayk6IHN0cmluZ1tdIHtcbiAgbGV0IHByb3BzID0gW11cbiAgbGV0IG9iaiA9IHRvQ2hlY2tcblxuICBkbyB7XG4gICAgcHJvcHMgPSBwcm9wcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKSlcbiAgfSB3aGlsZSAoKG9iaiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopKSlcbiAgcmV0dXJuIHByb3BzXG4gICAgLnNvcnQoKVxuICAgIC5maWx0ZXIoKGUsIGksIGFycikgPT4gZSAhPSBhcnJbaSArIDFdICYmIHR5cGVvZiB0b0NoZWNrW2VdICE9PSAnZnVuY3Rpb24nKVxufVxuXG5mdW5jdGlvbiBpc1dyaXRhYmxlRmllbGQob2JqZWN0LCBmaWVsZE5hbWUpOiBib29sZWFuIHtcbiAgY29uc3QgZmllbGREZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIGZpZWxkTmFtZSlcbiAgcmV0dXJuIGZpZWxkRGVzY3JpcHRvciAmJiBmaWVsZERlc2NyaXB0b3Iud3JpdGFibGVcbn1cblxuZnVuY3Rpb24gaXNXcml0ZWFibGVPYmplY3RGaWVsZChvYmplY3QsIGZpZWxkTmFtZSk6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIGlzV3JpdGFibGVGaWVsZChvYmplY3QsIGZpZWxkTmFtZSkgJiZcbiAgICB0eXBlb2Ygb2JqZWN0W2ZpZWxkTmFtZV0gPT09ICdvYmplY3QnICYmXG4gICAgb2JqZWN0W2ZpZWxkTmFtZV0gIT09IG51bGxcbiAgKVxufVxuXG5mdW5jdGlvbiBpc1dyaXRlYWJsZVByaW1pdGl2ZUZpZWxkKG9iamVjdCwgZmllbGROYW1lKTogYm9vbGVhbiB7XG4gIHJldHVybiAoXG4gICAgaXNXcml0YWJsZUZpZWxkKG9iamVjdCwgZmllbGROYW1lKSAmJlxuICAgICh0eXBlb2Ygb2JqZWN0W2ZpZWxkTmFtZV0gIT09ICdvYmplY3QnIHx8IG9iamVjdFtmaWVsZE5hbWVdID09PSBudWxsKVxuICApXG59XG5cbmZ1bmN0aW9uIGlzV3JpdGVhYmxlQXJyYXkob2JqZWN0LCBmaWVsZE5hbWUpOiBib29sZWFuIHtcbiAgcmV0dXJuIGlzV3JpdGFibGVGaWVsZChvYmplY3QsIGZpZWxkTmFtZSkgJiYgQXJyYXkuaXNBcnJheShvYmplY3RbZmllbGROYW1lXSlcbn1cblxuZnVuY3Rpb24gYXR0YWNoUHJveHlUb1Byb3BlcnRpZXMobW9kZWw6IE1vZGVsLCBjYWxsYmFjazogRnVuY3Rpb24sIGlkPyk6IHZvaWQge1xuICBpZiAoIW1vZGVsLl9fcHJveHlBdHRhY2hlZCkge1xuICAgIG1vZGVsLl9fcHJveHlBdHRhY2hlZCA9IHRydWVcbiAgICBnZXRGaWVsZE5hbWVzKG1vZGVsKS5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdXNlLWJlZm9yZS1kZWZpbmVcbiAgICAgIHJlY3Vyc2l2ZWx5QXR0YWNoUHJveHkoXG4gICAgICAgIG1vZGVsW2ZpZWxkXSxcbiAgICAgICAgZmllbGQsXG4gICAgICAgIG1vZGVsLFxuICAgICAgICBpZCA/IGlkIDogbW9kZWwuX19vYnNlcnZhYmxlSWQsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApXG4gICAgfSlcbiAgfVxufVxuXG5mdW5jdGlvbiBhdHRhY2hQcm94eVRvRmllbGQoXG4gIG9iamVjdCxcbiAgZmllbGROYW1lLFxuICBvcmlnaW5hbEZpZWxkLFxuICBjYWxsYmFjayxcbiAgaWRcbik6IHZvaWQge1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqZWN0LCBmaWVsZE5hbWUsIHtcbiAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICBnZXQ6ICgpID0+IG9yaWdpbmFsRmllbGQsXG4gICAgc2V0OiB2YWx1ZSA9PiB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICBhdHRhY2hQcm94eVRvUHJvcGVydGllcyh2YWx1ZSwgY2FsbGJhY2ssIGlkKVxuICAgICAgfVxuICAgICAgb3JpZ2luYWxGaWVsZCA9IHZhbHVlXG4gICAgICBjYWxsYmFjaygpXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiBhdHRhY2hQcm94eVRvQXJyYXkob2JqZWN0LCBmaWVsZE5hbWUsIGNhbGxiYWNrLCBpZCk6IHZvaWQge1xuICBvYmplY3RbZmllbGROYW1lXS5mb3JFYWNoKChlbGVtZW50LCBpbmRleCkgPT4ge1xuICAgIHJlY3Vyc2l2ZWx5QXR0YWNoUHJveHkoZWxlbWVudCwgaW5kZXgsIG9iamVjdFtmaWVsZE5hbWVdLCBpZCwgY2FsbGJhY2spXG4gIH0pXG4gIG9iamVjdFtmaWVsZE5hbWVdID0gbmV3IFByb3h5KG9iamVjdFtmaWVsZE5hbWVdLCB7XG4gICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KTogb2JqZWN0IHtcbiAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldXG4gICAgfSxcbiAgICBzZXQ6IGZ1bmN0aW9uKHRhcmdldCwgcHJvcGVydHksIHZhbHVlKTogYm9vbGVhbiB7XG4gICAgICBpZiAocHJvcGVydHkgIT09ICdfX3Byb3RvX18nICYmIHByb3BlcnR5ICE9PSAnbGVuZ3RoJykge1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgIGF0dGFjaFByb3h5VG9Qcm9wZXJ0aWVzKHZhbHVlLCBjYWxsYmFjaywgaWQpXG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0W3Byb3BlcnR5XSA9IHZhbHVlXG4gICAgICAgIGNhbGxiYWNrKClcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiByZWN1cnNpdmVseUF0dGFjaFByb3h5KFxuICBvcmlnaW5hbEZpZWxkLFxuICBmaWVsZE5hbWUsXG4gIG9iamVjdCxcbiAgaWQsXG4gIGNhbGxiYWNrOiBGdW5jdGlvblxuKTogdm9pZCB7XG4gIGlmIChpc1dyaXRlYWJsZVByaW1pdGl2ZUZpZWxkKG9iamVjdCwgZmllbGROYW1lKSlcbiAgICByZXR1cm4gYXR0YWNoUHJveHlUb0ZpZWxkKG9iamVjdCwgZmllbGROYW1lLCBvcmlnaW5hbEZpZWxkLCBjYWxsYmFjaywgaWQpXG4gIGlmIChpc1dyaXRlYWJsZUFycmF5KG9iamVjdCwgZmllbGROYW1lKSlcbiAgICByZXR1cm4gYXR0YWNoUHJveHlUb0FycmF5KG9iamVjdCwgZmllbGROYW1lLCBjYWxsYmFjaywgaWQpXG4gIGlmIChpc1dyaXRlYWJsZU9iamVjdEZpZWxkKG9iamVjdCwgZmllbGROYW1lKSkge1xuICAgIGF0dGFjaFByb3h5VG9GaWVsZChvYmplY3QsIGZpZWxkTmFtZSwgb3JpZ2luYWxGaWVsZCwgY2FsbGJhY2ssIGlkKVxuICAgIGdldEZpZWxkTmFtZXMob2JqZWN0W2ZpZWxkTmFtZV0pLmZvckVhY2gobmVzdGVkRmllbGROYW1lID0+XG4gICAgICByZWN1cnNpdmVseUF0dGFjaFByb3h5KFxuICAgICAgICBvYmplY3RbZmllbGROYW1lXVtuZXN0ZWRGaWVsZE5hbWVdLFxuICAgICAgICBuZXN0ZWRGaWVsZE5hbWUsXG4gICAgICAgIG9iamVjdFtmaWVsZE5hbWVdLFxuICAgICAgICBpZCxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgIClcbiAgICApXG4gICAgcmV0dXJuXG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkSWQobW9kZWw6IE1vZGVsKTogdm9pZCB7XG4gIGlmICghbW9kZWwuX19vYnNlcnZhYmxlSWQpXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG1vZGVsLCAnX19vYnNlcnZhYmxlSWQnLCB7XG4gICAgICB2YWx1ZTogaWQoKSxcbiAgICAgIHdyaXRhYmxlOiBmYWxzZVxuICAgIH0pXG59XG5cbmZ1bmN0aW9uIGFkZEhhc2gobW9kZWw6IE1vZGVsKTogdm9pZCB7XG4gIGlmICghbW9kZWwuaGFzaCkgbW9kZWwuaGFzaCA9ICgpOiBzdHJpbmcgPT4gaGFzaChtb2RlbClcbn1cblxubGV0IGN1cnJlbnRJZCA9IDBcblxuZXhwb3J0IGZ1bmN0aW9uIHVzZVVuaXF1ZUlkKCk6IHN0cmluZyB7XG4gIGNvbnN0IHJlZiA9IHVzZVJlZigwKVxuICBpZiAocmVmLmN1cnJlbnQgPT09IDApIHtcbiAgICByZWYuY3VycmVudCA9ICsrY3VycmVudElkXG4gIH1cbiAgcmV0dXJuICdzdWJzY3JpcHRpb25faWQnICsgcmVmLmN1cnJlbnRcbn1cblxuZnVuY3Rpb24gcmVhY3RpZnkobW9kZWw6IE1vZGVsKTogRnVuY3Rpb24ge1xuICBjb25zdCBzdWJzY3JpcHRpb25JZCA9IHVzZVVuaXF1ZUlkKClcbiAgY29uc3QgWywgc3RhdGVDaGFuZ2VdID0gdXNlU3RhdGUobW9kZWwuaGFzaCgpKVxuXG4gIGNvbnN0IHN0YXRlQ2hhbmdlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgc3RhdGVDaGFuZ2UobW9kZWwuaGFzaCgpKVxuICB9LCBbbW9kZWwuX19vYnNlcnZhYmxlSWRdKVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgZXZlbnRFbWl0dGVyLm9uKG1vZGVsLl9fb2JzZXJ2YWJsZUlkLCBzdWJzY3JpcHRpb25JZCwgc3RhdGVDaGFuZ2VDYWxsYmFjaylcbiAgICByZXR1cm4gKCk6IHZvaWQgPT4gZXZlbnRFbWl0dGVyLnJlbW92ZShtb2RlbC5fX29ic2VydmFibGVJZCwgc3Vic2NyaXB0aW9uSWQpXG4gIH0sIFttb2RlbC5fX29ic2VydmFibGVJZCwgc3Vic2NyaXB0aW9uSWRdKVxuICByZXR1cm4gKCk6IHZvaWQgPT4gZXZlbnRFbWl0dGVyLmVtaXQobW9kZWwuX19vYnNlcnZhYmxlSWQpXG59XG5cbmZ1bmN0aW9uIGRlY29yYXRlKG1vZGVsOiBNb2RlbCk6IHZvaWQge1xuICBhZGRIYXNoKG1vZGVsKVxuICBhZGRJZChtb2RlbClcbn1cblxuZnVuY3Rpb24gdXNlT2JzZXJ2ZXI8VCBleHRlbmRzIE1vZGVsPihtb2RlbDogVCk6IFQge1xuICBkZWNvcmF0ZShtb2RlbClcbiAgY29uc3QgY2FsbGJhY2sgPSByZWFjdGlmeShtb2RlbClcbiAgYXR0YWNoUHJveHlUb1Byb3BlcnRpZXMobW9kZWwsIGNhbGxiYWNrKVxuICByZXR1cm4gbW9kZWxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHB1cmVPYnNlcnZlcjxUIGV4dGVuZHMgTW9kZWw+KG1vZGVsOiBULCBjYWxsYmFjazogRnVuY3Rpb24pOiBUIHtcbiAgZGVjb3JhdGUobW9kZWwpXG4gIGF0dGFjaFByb3h5VG9Qcm9wZXJ0aWVzKG1vZGVsLCBjYWxsYmFjaylcbiAgcmV0dXJuIG1vZGVsXG59XG5cbmV4cG9ydCBkZWZhdWx0IHVzZU9ic2VydmVyXG4iXX0=